# ADR-003: Ограничения размеров ввода для защиты от DoS
Дата: 2025-10-31
Статус: Accepted

## Context
Recipe Box принимает пользовательский ввод (названия рецептов, шаги приготовления, ингредиенты). Без ограничений размеров возникают риски:
- **DoS атаки**: злоумышленник отправляет гигантские JSON payload → исчерпание памяти/CPU
- **Неконтролируемый рост БД**: пользователи сохраняют многомегабайтные строки
- **Проблемы с UI/UX**: сверхдлинные тексты ломают интерфейс
- **Медленные запросы**: валидация/сериализация больших данных замедляет API

### Текущее состояние:
- Нет явных лимитов на длину полей
- FastAPI/Pydantic по умолчанию не ограничивают размер строк

### Альтернативы:
1. **Без лимитов** (статус-кво) — максимальная гибкость, но высокий риск DoS
2. **Server-level лимиты** (nginx `client_max_body_size`) — защита от огромных тел, но не от длинных строк
3. **Application-level валидация** (Pydantic `max_length`) — точный контроль, хорошая диагностика
4. **БД constraints** — последний рубеж, но плохие ошибки для пользователя

## Decision
Реализуем **application-level лимиты** через Pydantic validators со следующими порогами:

### Лимиты полей:
```python
# Recipe
title: max_length=200       # достаточно для названия
steps: max_length=10_000    # ~2-3 страницы текста

# Ingredient
name: max_length=100        # "Мука пшеничная высшего сорта"

# RecipeIngredient
amount: max 999_999.99      # разумный максимум для количества
unit: max_length=10         # "tbsp" + запас

# Количество ингредиентов в рецепте
max_ingredients: 100        # защита от списков-гигантов
```

### Server-level (дополнительно):
```python
# FastAPI max body size (если не настроен nginx/proxy)
max_request_body_size: 1 MB
```

### Поведение при превышении:
- HTTP 422 Unprocessable Entity
- RFC 7807 формат с `code=validation_error`
- `detail` указывает конкретное поле и лимит

## Consequences

### Плюсы:
- **Защита от DoS**: нельзя отправить 1GB JSON
- **Контроль ресурсов**: предсказуемое потребление памяти/CPU/диска
- **Улучшенная валидация**: пользователь получает чёткую ошибку "title превышает 200 символов"
- **Совместимость с БД**: можно установить VARCHAR(200) без риска truncation

### Минусы:
- Ограничения могут быть слишком строгими для edge cases (очень длинные рецепты)
- Требует тестирования граничных значений
- Пользователи могут быть недовольны лимитами

### Компромиссы:
- 10,000 символов для `steps` — компромисс между гибкостью и безопасностью
- 100 ингредиентов — больше чем нужно для 99% рецептов, но защищает от абуза
- При необходимости можно поднять лимиты (backward compatible change)

### Влияние на производительность:
- Минимальное (len() проверка ~O(1) для небольших строк, O(n) для больших, но отклоняются до обработки)
- Снижение нагрузки за счёт ранней валидации

### Влияние на безопасность:
- Значительное снижение attack surface для DoS
- Предотвращение resource exhaustion

## Links
- **NFR-10**: Ограничения размеров ввода (title ≤200, steps ≤10k, ингредиентов ≤100)
- **R9**: Переполнение входа/большие тела → отказ (избежание риска)
- **Тесты**:
  - `tests/test_recipes.py::test_title_max_length`
  - `tests/test_recipes.py::test_steps_max_length`
  - `tests/test_recipes.py::test_max_ingredients_limit`
  - `tests/test_recipes.py::test_amount_max_value`

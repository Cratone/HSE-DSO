# ADR-001: RFC 7807 Error Format with Correlation ID
Дата: 2025-10-31
Статус: Accepted

## Context
Необходимо:
- Стандартизированный формат ошибок согласно RFC 7807 (Problem Details for HTTP APIs)
- Correlation ID для трассировки запросов через логи и микросервисы
- Маскирование чувствительных деталей (не раскрывать внутренние ошибки БД, пути к файлам)
- Единообразная обработка 4xx и 5xx ошибок

### Альтернативы:
1. **Формат** `{"error": {...}}` — прост, но не стандартизирован, нет correlation_id
2. **RFC 7807** — индустриальный стандарт, поддержка correlation_id, расширяемость
3. **GraphQL errors** — не применимо, т.к. используем REST API

## Decision
Реализуем RFC 7807 Problem Details format со следующими полями:
- `type` (URI идентификатор типа проблемы, по умолчанию "about:blank")
- `title` (краткое человекочитаемое описание)
- `status` (HTTP статус код)
- `detail` (подробное описание, безопасное для клиента)
- `correlation_id` (UUID для трассировки)

### Конфигурация:
```python
# Для всех ошибок генерируется correlation_id
# Внутренние исключения (500) маскируются как "internal_server_error"
# Валидационные ошибки (422) содержат безопасные детали
```

### Пороги/метрики:
- 100% API эндпоинтов возвращают RFC 7807 формат
- 0 утечек внутренних деталей (stack traces, DB errors) в production
- ≥95% запросов имеют correlation_id в логах

## Consequences

### Плюсы:
- Стандартизированный формат, понятный разработчикам и инструментам мониторинга
- Correlation ID облегчает debugging и трассировку инцидентов
- Безопасность: маскирование внутренних ошибок предотвращает information disclosure
- Расширяемость: можно добавлять дополнительные поля (instance, etc.)

### Минусы:
- Необходимо обновить все exception handlers
- Клиенты должны адаптироваться к новому формату (breaking change)
- Небольшой overhead на генерацию UUID для каждого запроса

### Влияние на DX:
- Улучшается опыт отладки благодаря correlation_id
- Требуется документация для разработчиков API

### Влияние на производительность:
- Минимальное (генерация UUID ~1-2 мкс)

## Links
- **NFR-04**: Стандартизированный формат ошибок (100% покрытие эндпоинтов)
- **NFR-07**: Логирование с correlation_id (95% запросов)
- **R8**: Детали ошибок раскрывают систему/PII (снижение риска)
- **R10**: Потеря трассируемости инцидентов (снижение риска)
- **Тесты**: `tests/test_errors.py::test_rfc7807_format`, `tests/test_errors.py::test_correlation_id_present`

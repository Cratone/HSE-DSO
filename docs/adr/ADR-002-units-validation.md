# ADR-002: Строгая валидация единиц измерения ингредиентов
Дата: 2025-10-31
Статус: Accepted

## Context
В Recipe Box пользователи указывают количество ингредиентов с единицами измерения (units). Неконтролируемый ввод units создаёт риски:
- Некорректные расчёты при масштабировании рецептов (г vs кг, мл vs л)
- Несовместимые данные (пользователь вводит "щепотка", "немного")
- Проблемы интеграции с внешними системами (нутриционные калькуляторы)
- Сложность нормализации и конвертации

### Бизнес-требования:
- Поддержка метрических и кулинарных единиц
- Предотвращение ошибок пользователей
- Совместимость с будущими фичами (конвертация, расчёт калорий)

### Альтернативы:
1. **Свободный ввод** — гибкость, но хаос в данных
2. **Enum с разрешёнными units** — стандартизация, простая валидация
3. **Числовая система с базовыми единицами** — сложно
4. **Внешняя библиотека units** (pint, etc.) — overhead, зависимость

## Decision
Реализуем **whitelist валидацию** с разрешёнными единицами измерения:

### Разрешённые units:
- **Вес**: `g` (граммы), `kg` (килограммы)
- **Объём**: `ml` (миллилитры), `l` (литры)
- **Кулинарные**: `tsp` (чайная ложка), `tbsp` (столовая ложка)
- **Штучные**: `pcs` (штуки)

### Правила валидации:
```python
ALLOWED_UNITS = {"g", "kg", "ml", "l", "tsp", "tbsp", "pcs"}

def validate_unit(unit: str) -> bool:
    return unit in ALLOWED_UNITS
```

### Применение:
- POST/PUT `/recipes` — валидация всех ингредиентов
- POST/PUT `/ingredients` — валидация при создании/обновлении
- Ошибка 422 с `code=validation_error` при неразрешённом unit

### Пороги:
- 100% create/update запросов проверяют units
- 0 сохранений ингредиентов с невалидными units

## Consequences

### Плюсы:
- Гарантированное качество данных
- Простая реализация (1 функция, 1 set lookup O(1))
- Совместимость с будущими фичами (конвертация между метрическими единицами)
- Улучшенный UX: чёткая обратная связь при ошибке

### Минусы:
- Ограниченная гибкость для пользователей (нельзя "щепотка", "по вкусу")
- Требует расширения списка при новых требованиях
- Breaking change для существующих клиентов (если были данные с другими units)

### Компромиссы:
- Отказываемся от свободного ввода в пользу консистентности данных
- В будущем можно добавить поле `note` для текстовых уточнений ("по вкусу")

### Влияние на производительность:
- Минимальное (set lookup ~O(1), 7 элементов)

### Влияние на безопасность:
- Снижение риска injection attacks через unit поле
- Предотвращение логических ошибок в расчётах

## Links
- **NFR-05**: Валидация единиц измерения (100% покрытие)
- **R4**: Неверные units ломают расчёты/данные (закрытие риска)
- **Тесты**:
  - `tests/test_ingredients.py::test_valid_units`
  - `tests/test_ingredients.py::test_invalid_unit_rejected`
  - `tests/test_ingredients.py::test_unit_validation_422`

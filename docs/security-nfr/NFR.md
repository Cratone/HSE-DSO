# Security NFR

| ID     | Название                                 | Описание                                                                 | Метрика/Порог                                   | Проверка (чем/где)                                                        | Компонент   | Приоритет |
|--------|------------------------------------------|--------------------------------------------------------------------------|-------------------------------------------------|---------------------------------------------------------------------------|-------------|-----------|
| NFR-01 | Хранение паролей Argon2id                | Пароли пользователей хэшируются только Argon2id с заданными параметрами. | Argon2id: t=3, m=256MB, p=1                      | Ревью конфига/кода + unit‑тест параметров хэширования                     | auth        | High      |
| NFR-02 | JWT и секреты                            | Доступ по JWT; секрет в env/secret store; регулярная ротация.            | TTL токена ≤ 24 ч; ротация секрета ≤ 90 дней     | Конфигурация окружения + чек‑лист DevOps; ссылка на секрет/политику       | auth        | High      |
| NFR-03 | Owner‑only доступ к рецептам             | Пользователь видит/меняет только свои рецепты.                           | 0 успешных IDOR‑проходов в e2e                   | E2E/контракт‑тесты на 403/404 при доступе к чужим ресурсам                | recipes     | High      |
| NFR-04 | Стандартизированный формат ошибок        | Единый конверт ошибок: {"error": {"code","message"}} для 100% API.    | Покрытие 100% эндпоинтов                         | Контракт‑тесты ошибок (404/422/401/403)                                   | api         | Medium    |
| NFR-05 | Валидация единиц измерения               | Разрешённые units: g, kg, ml, l, tsp, tbsp, pcs.                         | 100% create/update отклоняют неразрешённые units | Unit/интеграционные тесты: 422 + code=validation_error                    | recipes     | High      |
| NFR-06 | Ограничение скорости для мутаций         | Защита от брут/спама на write‑эндпоинтах.                                | 429 при >100 req/min на пользователя или IP      | Интеграционный негативный тест с бурстом запросов                         | api         | Medium    |
| NFR-07 | Логирование без PII + correlation_id     | Не логировать пароли/секреты/токены; корреляция запросов.                | 0 попаданий PII/secret в логи; 95% запросов с cid | Статический анализ логов в CI (grep) + ручная проверка конфигурации       | platform    | Medium    |
| NFR-08 | Производительность поиска рецептов       | Поиск по ингредиенту отвечает быстро при умеренной нагрузке.             | p95 GET /recipes?ingredient= ≤ 200 ms @ 30 RPS   | Нагрузочный тест (k6/locust) в stage‑окружении, отчёт в артефактах CI     | api         | Medium    |
| NFR-09 | Уязвимости зависимостей (SCA)            | High/Critical не висят неделями.                                         | Возраст High/Critical ≤ 7 дней                   | CI: pip‑audit/safety отчёт; тикет создаётся автоматически/вручную          | build/ci    | High      |
| NFR-10 | Ограничения размеров ввода               | Защита от DoS длинными полями/списками.                                   | title ≤ 200; steps ≤ 10k симв.; ингредиентов ≤ 100 | Валидационные тесты 422; fuzz/neg‑тесты на предельные размеры              | api/recipes | Medium    |

Примечания по проверкам:
- «Контракт‑тесты» — pytest тесты, проверяющие структуру ответа и коды состояний.
- «Нагрузочный тест» — локально/на stage; отчёт прикладывается в CI как артефакт.
- Валидация units должна выполняться во всех write‑операциях: создание/обновление рецептов и их ингредиентов.
